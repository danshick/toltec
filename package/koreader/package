#!/usr/bin/env bash
# Copyright (c) 2020 The Toltec Contributors
# SPDX-License-Identifier: MIT

pkgnames=(koreader)
pkgdesc="An ebook reader application supporting PDF, DjVu, EPUB, FB2 and many more formats"
url=https://github.com/koreader/koreader
pkgver=2020.12-1
timestamp=2020-10-10T20:13Z
section=readers
maintainer="raisjn <of.raisjn@gmail.com>"
license=AGPL-3.0-or-later
depends=(fbink fbdepth)

_srcver="v${pkgver%-*}"
source=("https://build.koreader.rocks/download/stable/$_srcver/koreader-remarkable-$_srcver.zip")
sha256sums=(38db8f3895472828d7c1d63fc54db426135a8dbf8425633e299a1a9abfdb69b2)

_applicationRegistered="[[ \"\$(rot apps get applications | jq -rc '.KOReader')\" != 'null' ]]"
_unregisterApplication="rot apps get applications | jq -rc '.KOReader' | sed 's|/codes/eeems/oxide1/||' | xargs -I {} rot --object 'Application:{}' apps call unregister"

package() {
    install -d "$pkgdir"/opt/koreader
    cp -R "$srcdir"/* "$pkgdir"/opt/koreader/
    rm "$pkgdir"/opt/koreader/koreader*zip
    rm "$pkgdir"/opt/koreader/{fbink,fbdepth}
    ln -s /opt/bin/fbink "$pkgdir"/opt/koreader/fbink
    ln -s /opt/bin/fbdepth "$pkgdir"/opt/koreader/fbdepth

    install -D -m 644 -t "$pkgdir"/opt/etc/draft/ "$recipedir"/koreader.draft
    install -D -m 644 -t "$pkgdir"/opt/etc/draft/icons/ "$srcdir"/resources/koreader.png
    install -D -m 755 -t "$pkgdir"/opt/bin/ "$recipedir"/koreader
}

configure() {
    # Is Oxide installed?
    if systemctl list-units --full -all | grep -Fq 'tarnish.service'; then
        # Check to see if tarnish is running and rot is available
        if command -v rot &> /dev/null && systemctl is-active --quiet tarnish; then
            sh -c "$_applicationRegistered" && sh -c "$_unregisterApplication"
            result=$(rot apps call registerApplication 'QVariantMap:{"name": "KOReader", "displayName": "KOReader", "decription": "ebook reader", "bin": "/opt/bin/koreader", "icon": "/opt/etc/draft/icons/koreader.png", "onStop": "killall -9 luajit", "onPause": "killall -STOP luajit || true && /opt/koreader/fbdepth -d 16 -r 1", "onResume": "/opt/koreader/fbdepth -d 8 -r 1 || true && killall -CONT luajit"}')
            if [[ "$result" != '"/"' ]] && [[ "$result" != "" ]]; then
                # Registered successfully, so we can exit
                return
            fi
        fi
        echo "KOReader has an outstanding bug where it doesn't resize the screen properly when returning to Oxide. See Oxide's release notes for a workaround."
    fi
}
postremove() {
    # Check to see if tarnish is running and rot is available
    if systemctl list-units --full -all | grep -Fq 'tarnish.service' && command -v rot &> /dev/null && systemctl is-active --quiet tarnish; then
        if sh -c "$_applicationRegistered" && ! sh -c "$_unregisterApplication"; then
            echo "You may need to manually remove the application entry for KOReader in Oxide."
        fi
    fi
}
